#!/usr/bin/env node

var moo     = require('../'),
    fs      = require('fs'),
    util    = require('util'),
    path    = require('path'),
    program = require('commander');

var exportHtml = function (inputPath, output) {
  var markup = new moo.Markup(inputPath);
  markup.export(function (err, html) {
    if (err)
      console.error(err);
    else
      output.end(html);
  });
};

program
  .version('0.3.0')
  .option('-e, --export', 'export rendered HTML only')
  .option('-p, --port <port>', "server port [default: random]", parseInt, 0)
  .parse(process.argv);

var args = program.args;

if (!program.export) {
  // preview mode
  if (args.length !== 1) {
    console.error("expect one input file");
    process.exit(1);
  }
  if (!fs.existsSync(args[0])) {
    console.error("input file '" + args[0] + "' doesn't exist");
    process.exit(1);
  }
  var server = new moo.Server(args[0]);
  server.listen(program.port);
} else {
  // export mode
  if (!args) {
    console.error("no input file specified");
    process.exit(1);
  }
  // process each arguments
  for (var i = 0; i < args.length; args++) {
    var arg = args[i];
    var inputPath = path.resolve(process.cwd(), arg);

    if (fs.existsSync(inputPath)) {
      var inputStats = fs.statSync(inputPath);
      if (!inputStats.isFile()) {
        console.warn("ignoring directory '" + inputPath + "'");
      } else {
        var outdir = path.dirname(arg);
        var outputName = path.basename(inputPath, path.extname(inputPath)) + '.html';
        var outputPath = path.join(outdir, outputName);
        var outputStream = fs.createWriteStream(outputPath, {
          flags: 'w',
          encoding: 'utf8'
        });

        console.log("exporting '" + inputPath + "'");
        exportHtml(inputPath, outputStream, program);
      }
    } else {
      console.error("input file '" + arg + "' not found");
    }
  }
}



